name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run unit tests
      run: |
        python run_tests.py --unit
      continue-on-error: false
    
    - name: Run integration tests
      run: |
        python run_tests.py --integration
      continue-on-error: false
      env:
        # Set test environment variables (no real credentials needed for mocked tests)
        HYPERLIQUID_TESTNET: 'true'
    
    - name: Run all tests
      if: matrix.python-version == '3.11'
      run: |
        python run_tests.py
      continue-on-error: false

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Check code formatting with Black
      run: |
        black --check --line-length=100 --exclude="venv|\.venv|test_.*\.py" .
      continue-on-error: false
    
    - name: Lint with Flake8
      run: |
        flake8 --max-line-length=100 \
               --extend-ignore=E203,W503 \
               --exclude=venv,.venv,__pycache__,.git \
               --max-complexity=10 \
               .
      continue-on-error: false
    
    - name: Check import sorting with isort
      run: |
        isort --check-only --profile=black --line-length=100 --skip="venv|\.venv" .
      continue-on-error: false
    
    - name: Type check with mypy
      run: |
        mypy --ignore-missing-imports \
             --no-strict-optional \
             --warn-return-any \
             --warn-unused-configs \
             --exclude="test_.*\.py|venv|\.venv" \
             .
      continue-on-error: false

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Check for private keys
      run: |
        # Check for common private key patterns
        if grep -r "0x[a-fA-F0-9]\{64\}" --include="*.py" --include="*.json" . | grep -v "test_" | grep -v "example"; then
          echo "⚠️  Potential private key found in code"
          exit 1
        fi
        echo "✅ No private keys detected"
      continue-on-error: true
    
    - name: Check for hardcoded credentials
      run: |
        # Check for common credential patterns
        if grep -ri "api_key.*=.*['\"][^'\"]\{20,\}" --include="*.py" . | grep -v "test_" | grep -v "example"; then
          echo "⚠️  Potential hardcoded API key found"
          exit 1
        fi
        echo "✅ No hardcoded credentials detected"
      continue-on-error: true

  build:
    name: Build Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verify imports
      run: |
        python -c "
        import sys
        errors = []
        modules = [
            'hyperliquid_client',
            'macd_strategy',
            'risk_manager',
            'trading_bot',
            'exceptions',
            'constants',
            'input_sanitizer',
            'response_validator',
            'credential_manager',
            'order_tracker',
            'rate_limiter',
            'audit_logger',
            'health_monitor',
            'backtester'
        ]
        for module in modules:
            try:
                __import__(module)
                print(f'✅ {module}')
            except Exception as e:
                errors.append(f'❌ {module}: {e}')
                print(f'❌ {module}: {e}')
        if errors:
            sys.exit(1)
        "
      continue-on-error: false

