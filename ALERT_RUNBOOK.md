# Trading Bot Alert Runbook

This runbook provides detailed response procedures for all alerts generated by the trading bot monitoring system. Follow these procedures to ensure timely and effective incident response.

## Alert Severity Levels

### üî¥ CRITICAL (Immediate Action Required)
- **Response Time**: Within 5 minutes
- **Escalation**: Immediate notification to on-call engineer
- **Impact**: Potential financial loss or system failure

### üü° WARNING (Review Within 30 Minutes)
- **Response Time**: Within 30 minutes
- **Escalation**: Email/SMS notification
- **Impact**: Performance degradation or risk increase

### ‚ÑπÔ∏è INFO (Daily Digest)
- **Response Time**: Review during daily checks
- **Escalation**: None required
- **Impact**: Informational only

---

## CRITICAL ALERTS

### üö® Bot Crashed/Stopped

**Alert Condition**: Trading bot process is not responding or has crashed

**Symptoms**:
- No metrics updates
- Health endpoint returns 503
- WebSocket disconnected
- Trading stopped

**Immediate Actions** (0-5 minutes):
1. **Check Process Status**:
   ```bash
   ps aux | grep trading_bot
   ```

2. **Restart Bot**:
   ```bash
   cd /path/to/bot
   source venv/bin/activate
   python trading_bot.py &
   ```

3. **Verify Recovery**:
   - Check health endpoint: `curl http://localhost:8001/health`
   - Monitor metrics in Grafana
   - Verify WebSocket reconnection

**Investigation** (5-15 minutes):
1. Check recent logs:
   ```bash
   tail -100 logs/trading_bot.log | jq '.message'
   ```

2. Look for error patterns:
   ```bash
   grep -i error logs/trading_bot_errors.log
   ```

3. Check system resources:
   ```bash
   htop
   df -h
   ```

**Prevention**:
- Implement process monitoring (systemd/pm2)
- Add automatic restart on failure
- Review error logs for root cause

**Escalation**: If bot cannot be restarted within 10 minutes, escalate to senior engineer

---

### üîå WebSocket Disconnected >2 Minutes

**Alert Condition**: WebSocket connection lost for more than 2 minutes

**Symptoms**:
- Real-time price data unavailable
- Increased API call frequency
- Potential trading delays

**Immediate Actions** (0-2 minutes):
1. **Check Network Connectivity**:
   ```bash
   ping api.hyperliquid.xyz
   curl -I https://api.hyperliquid.xyz
   ```

2. **Restart WebSocket Connection**:
   - Bot should auto-reconnect (check logs for reconnection attempts)
   - If manual restart needed: `pkill -f trading_bot && python trading_bot.py &`

3. **Verify Connection**:
   ```bash
   curl http://localhost:8001/health | jq '.checks.websocket_connectivity'
   ```

**Investigation** (2-10 minutes):
1. Check WebSocket logs:
   ```bash
   grep websocket logs/trading_bot.log | tail -20
   ```

2. Network diagnostics:
   ```bash
   traceroute api.hyperliquid.xyz
   mtr api.hyperliquid.xyz
   ```

3. Check for rate limiting:
   ```bash
   grep "rate limit" logs/trading_bot.log
   ```

**Prevention**:
- Implement connection pooling
- Add retry logic with exponential backoff
- Monitor Hyperliquid service status

---

### üí∞ Position Hit Stop-Loss

**Alert Condition**: Position closed due to stop-loss trigger

**Symptoms**:
- Unexpected position closure
- Realized losses
- Risk limit breach

**Immediate Actions** (0-5 minutes):
1. **Assess Situation**:
   ```bash
   curl http://localhost:8001/health | jq '.checks.position_health'
   ```

2. **Check Current Positions**:
   ```bash
   # Check via API or logs
   grep "position" logs/trading_bot.log | tail -10
   ```

3. **Review Stop-Loss Logic**:
   - Verify stop-loss was triggered correctly
   - Check if it was a trailing stop update

4. **Manual Position Review**:
   - Assess if manual intervention needed
   - Check account balance and margin

**Investigation** (5-15 minutes):
1. Analyze trade details:
   ```bash
   grep "TRADE EXIT" logs/trading_bot.log | tail -5
   ```

2. Review risk settings:
   ```bash
   cat config/config.json | jq '.risk_management'
   ```

3. Check market conditions:
   - Review price action leading to stop-loss
   - Assess if stop-loss was too tight

**Prevention**:
- Adjust stop-loss parameters
- Implement partial position closures
- Add market condition filters

---

### üìâ Daily Loss Limit Reached

**Alert Condition**: Daily loss limit exceeded (100% of threshold)

**Symptoms**:
- Trading suspended
- Circuit breaker activated
- Significant drawdown

**Immediate Actions** (0-5 minutes):
1. **Stop All Trading**:
   ```bash
   # Bot should auto-stop, but verify
   curl http://localhost:8001/health | jq '.status'
   ```

2. **Assess Losses**:
   ```bash
   curl http://localhost:8001/health | jq '.metrics.total_pnl'
   ```

3. **Manual Position Review**:
   - Check current positions
   - Assess liquidation needs

**Investigation** (5-30 minutes):
1. Analyze loss causes:
   ```bash
   # Generate loss analysis
   python -c "from trade_analytics import TradeAnalytics; ta = TradeAnalytics(); print(ta.generate_report(1))"
   ```

2. Review strategy performance:
   ```bash
   grep "strategy" logs/trading_bot.log | tail -20
   ```

3. Check risk parameters:
   ```bash
   cat config/config.json | jq '.risk_limits'
   ```

**Recovery Process**:
1. Reset daily loss counter (if appropriate)
2. Adjust risk limits temporarily
3. Resume trading with reduced position sizes
4. Schedule strategy review meeting

---

### üîê API Authentication Failed

**Alert Condition**: Authentication with Hyperliquid API failed

**Symptoms**:
- All API calls failing
- Trading impossible
- Authentication errors in logs

**Immediate Actions** (0-5 minutes):
1. **Check Credentials**:
   ```bash
   # Verify private key is accessible
   python -c "from secure_key_storage import SecureKeyStorage; ks = SecureKeyStorage(); print('Keys OK' if ks.validate_keys() else 'Keys INVALID')"
   ```

2. **Test API Connection**:
   ```bash
   python test_hyperliquid_connection.py
   ```

3. **Check Network/Proxy**:
   ```bash
   curl -v https://api.hyperliquid.xyz/info
   ```

**Investigation** (5-15 minutes):
1. Review authentication logs:
   ```bash
   grep "auth" logs/trading_bot_errors.log | tail -10
   ```

2. Check key expiration:
   ```bash
   # Verify key format and validity
   python -c "from eth_account import Account; print('Key format OK')"
   ```

3. Network diagnostics:
   ```bash
   openssl s_client -connect api.hyperliquid.xyz:443
   ```

**Recovery**:
- Rotate API keys if compromised
- Update wallet addresses if needed
- Verify EIP-712 signing works

---

### üí∏ Insufficient Balance

**Alert Condition**: Account balance too low to continue trading

**Symptoms**:
- Order rejections
- Trading suspended
- Margin call warnings

**Immediate Actions** (0-5 minutes):
1. **Check Balance**:
   ```bash
   curl http://localhost:8001/health | jq '.metrics.account_balance'
   ```

2. **Stop Trading**:
   - Bot should auto-stop, verify circuit breaker

3. **Assess Margin Requirements**:
   ```bash
   # Check current leverage and position sizes
   python -c "from risk_manager import RiskManager; rm = RiskManager(); print(rm.get_margin_usage())"
   ```

**Investigation** (5-30 minutes):
1. Analyze recent losses:
   ```bash
   python -c "from trade_analytics import TradeAnalytics; ta = TradeAnalytics(); report = ta.generate_report(1); print(report['performance'])"
   ```

2. Review position sizing:
   ```bash
   cat config/config.json | jq '.position_sizing'
   ```

3. Check for margin requirements:
   ```bash
   # Hyperliquid specific margin calculations
   ```

**Recovery**:
- Reduce position sizes
- Add funds to account
- Adjust leverage settings
- Implement stricter risk controls

---

## WARNING ALERTS

### ‚è±Ô∏è API Latency >5 Seconds

**Alert Condition**: API response time exceeds 5 seconds

**Symptoms**:
- Slow trade execution
- Potential missed opportunities
- Increased error rates

**Actions** (Within 30 minutes):
1. **Monitor Trend**:
   ```bash
   # Check latency graph in Grafana
   curl http://localhost:8000 | grep api_request_duration
   ```

2. **Check Network**:
   ```bash
   ping -c 10 api.hyperliquid.xyz
   ```

3. **Review API Usage**:
   ```bash
   grep "API CALL" logs/trading_bot.log | tail -20
   ```

**Investigation**:
- Check for rate limiting
- Review request batching
- Assess network congestion

**Resolution**:
- Implement request batching
- Add connection pooling
- Consider API endpoint optimization

---

### üß† Memory Usage >80%

**Alert Condition**: System memory usage exceeds 80%

**Symptoms**:
- Slow performance
- Potential crashes
- Increased swap usage

**Actions** (Within 30 minutes):
1. **Check Memory Usage**:
   ```bash
   htop
   free -h
   ```

2. **Identify Memory Leaks**:
   ```bash
   ps aux --sort=-%mem | head -10
   ```

3. **Restart if Necessary**:
   ```bash
   # If memory usage >90%, consider restart
   sudo systemctl restart trading-bot
   ```

**Investigation**:
- Check for memory leaks in code
- Review data retention settings
- Assess cache sizes

**Prevention**:
- Implement memory monitoring
- Add garbage collection tuning
- Reduce data retention windows

---

### üìä Win Rate Below 40%

**Alert Condition**: Trading win rate drops below 40%

**Symptoms**:
- Consistent losses
- Strategy ineffectiveness
- Increased drawdown risk

**Actions** (Within 30 minutes):
1. **Review Recent Performance**:
   ```bash
   python -c "from trade_analytics import TradeAnalytics; ta = TradeAnalytics(); print(ta.generate_report(1)['performance'])"
   ```

2. **Check Strategy Parameters**:
   ```bash
   cat config/config.json | jq '.strategy'
   ```

3. **Analyze Losing Trades**:
   ```bash
   grep "TRADE EXIT.*LOSS" logs/trading_bot.log | tail -10
   ```

**Investigation**:
- Review market conditions
- Check indicator accuracy
- Assess entry/exit timing

**Resolution**:
- Adjust strategy parameters
- Implement strategy switching
- Add market condition filters

---

## INFO ALERTS

### üìà Daily Trading Summary

**Alert Condition**: End-of-day summary (sent daily)

**Content**:
- Total trades executed
- Win rate and profit factor
- Total P&L
- Best/worst trades
- Risk metrics

**Actions** (Daily Review):
1. **Review Performance**:
   ```bash
   python -c "from trade_analytics import TradeAnalytics; ta = TradeAnalytics(); report = ta.generate_report(1); print(report['recommendations'])"
   ```

2. **Update Strategies**:
   - Adjust parameters based on performance
   - Review risk settings

3. **Generate Reports**:
   ```bash
   python -c "from trade_analytics import TradeAnalytics; ta = TradeAnalytics(); ta.export_report_pdf(ta.generate_report(1), 'daily_report.pdf')"
   ```

---

### üèÜ New Balance High

**Alert Condition**: Account balance reaches new all-time high

**Actions**:
- Celebrate success üéâ
- Document strategy effectiveness
- Consider scaling up (if appropriate)
- Backup configuration

---

## Emergency Procedures

### üö® Complete System Failure

**Immediate Actions**:
1. **Stop All Trading**:
   ```bash
   pkill -f trading_bot
   ```

2. **Assess Damage**:
   ```bash
   # Check positions via API
   python emergency_position_check.py
   ```

3. **Manual Liquidation if Needed**:
   ```bash
   # Use emergency liquidation script
   python emergency_liquidation.py
   ```

4. **Preserve Evidence**:
   ```bash
   # Backup all logs and data
   tar -czf emergency_backup_$(date +%Y%m%d_%H%M%S).tar.gz logs/ data/ config/
   ```

### üîí Security Breach Suspected

**Immediate Actions**:
1. **Isolate System**:
   ```bash
   # Disconnect from network if suspected breach
   sudo ifconfig eth0 down
   ```

2. **Secure Keys**:
   ```bash
   python -c "from secure_key_storage import SecureKeyStorage; ks = SecureKeyStorage(); ks.emergency_zeroize()"
   ```

3. **Change All Credentials**:
   - Rotate API keys
   - Update alert channel tokens
   - Change SSH keys

4. **Forensic Analysis**:
   - Preserve system logs
   - Document incident timeline
   - Contact authorities if funds stolen

---

## Communication Templates

### Internal Alert Notification

```
Subject: [ALERT] Trading Bot - {alert_type}

Alert Details:
- Severity: {severity}
- Time: {timestamp}
- Description: {description}
- Impact: {impact_assessment}

Actions Taken:
- {action1}
- {action2}

Next Steps:
- {investigation_steps}
- {escalation_plan}

Status: {OPEN|INVESTIGATING|RESOLVED}
```

### Stakeholder Communication

```
Subject: Trading System Status Update

Dear Team,

We experienced a {severity} incident with the trading system:

Issue: {brief_description}
Impact: {impact_on_trading}
Duration: {downtime_duration}

Root Cause: {identified_cause}
Resolution: {steps_taken}

Prevention: {preventive_measures}

The system is now {status}.
Please contact {on_call_engineer} with questions.

Best regards,
Trading Operations Team
```

---

## Metrics and KPIs

### Alert Effectiveness

- **Mean Time to Response (MTTR)**: Target <5min for critical, <30min for warnings
- **False Positive Rate**: Target <5%
- **Alert Volume**: Monitor for alert fatigue

### System Reliability

- **Uptime**: Target >99.9%
- **Mean Time Between Failures (MTBF)**: Track and improve
- **Recovery Time Objective (RTO)**: Target <10 minutes

### Monitoring Coverage

- **Alert Coverage**: % of failure scenarios with alerts
- **Detection Accuracy**: % of real issues detected
- **Investigation Efficiency**: Time to root cause identification

---

## Continuous Improvement

### Weekly Review Process

1. **Analyze Alert Patterns**:
   ```bash
   # Generate alert analysis
   python alert_analysis.py --period 7d
   ```

2. **Review Response Times**:
   - Track MTTR for each alert type
   - Identify bottlenecks

3. **Update Runbook**:
   - Add new failure scenarios
   - Improve response procedures

4. **Training**:
   - Conduct incident response drills
   - Update team knowledge base

### Quarterly Assessments

1. **System Reliability Review**
2. **Alert System Effectiveness**
3. **Process Improvement Implementation**
4. **Team Training Updates**

---

## Contact Information

### On-Call Engineers
- Primary: [Engineer Name] - [Phone] - [Email]
- Secondary: [Engineer Name] - [Phone] - [Email]

### External Support
- Hyperliquid Support: [Contact Info]
- Infrastructure Provider: [Contact Info]
- Monitoring Systems: [Contact Info]

### Escalation Path
1. **L1**: On-call engineer (0-15 min response)
2. **L2**: Senior engineer (15-60 min response)
3. **L3**: Engineering manager (1-4 hour response)
4. **L4**: Executive team (4+ hour response)

---

## Document Control

- **Version**: 1.0
- **Last Updated**: November 2025
- **Review Frequency**: Monthly
- **Approved By**: Trading Operations Team

For updates or questions, contact the DevOps team.
